<link rel="import" href="../../../../packages/polymer/polymer.html">
<link rel="import" href="../../../../packages/core_elements/core_icon.html">
<link rel="import" href="../../../../packages/paper_elements/paper_item.html">

<link rel="import" href="../components/grade_input.html">
<link rel="import" href="../components/grade_dropdown_menu.html">
<link rel="import" href="../components/grade_item.html">
<link rel="import" href="../components/grade_fascia.html">
<link rel="import" href="../components/loading_panel.html">
<link rel="import" href="../components/grade_uri.html">
<link rel="import" href="../components/grade_button.html">
<link rel="import" href="../components/field_error.html">
<link rel="import" href="../components/grade_selector.html">

<link rel="import" href="queries.html">

<polymer-element name="query-details" layout vertical> 

  <template>
  
		<style>
		  
		  grade-input::shadow [multiline] {
		     max-height: 150px;
		  }
		  
		  [truncate] {
		    overflow: hidden;
		    text-overflow: ellipsis;
		  }
		        
      [graphs-area] { min-height:80px; margin-top:15px }
      [pointer] { cursor:pointer }
        
      [invalid-graph] {
        text-decoration:line-through;
      }
		  
    </style>
		
    <div hidden?="{{item==null}}">

      <loading-panel loading="{{loading}}" message="saving the query">
	   
        <div style="overflow-y: auto;">

          <!-- name -->
          <grade-item icon=chevron-right>
	          
	          <grade-fascia truncate>
	                   
	            <grade-input fascia-title 
	                         disabled="{{ !editable }}" 
	                         label="{{ K.name | suffix }} ?" 
	                         required
	                         validators="{{ nameValidators}}"
	                         invalid="{{ item.fieldsInvalidity[K.name] }}"
	                         inputValue="{{ item.model.bean[K.name]  }}">
	            </grade-input>
	                   
	            <div fascia-subtitle><span>{{ K.name | start}}</span><span fg bolder>{{ K.name | suffix}}</span></div>
	            
            </grade-fascia>
	            
	        </grade-item>
          
          <!-- note -->
          <grade-item icon=chevron-right>
            
            <grade-fascia truncate>
                     
              <grade-input fascia-title 
                           disabled="{{ !editable }}" 
                           multiline
                           label="{{ K.note | suffix }} ?" 
                           invalid="{{ item.fieldsInvalidity[K.note] }}"
                           inputValue="{{ item.model.bean[K.note]  }}">
              </grade-input>
                     
              <div fascia-subtitle><span>{{ K.note | start}}</span><span fg bolder>{{ K.note | suffix}}</span></div>
              
            </grade-fascia>
              
          </grade-item>
          
          <!-- expression -->
          <grade-item icon=chevron-right>
            
            <grade-fascia truncate>
                     
              <grade-input fascia-title 
                           disabled="{{ !editable }}" 
                           multiline
                           required
                           label="{{ K.expression | suffix }} ?" 
                           invalid="{{ item.fieldsInvalidity[K.expression] }}"
                           inputValue="{{ item.model.bean[K.expression]  }}">
              </grade-input>
                     
              <div fascia-subtitle><span>{{ K.expression | start}}</span><span fg bolder>{{ K.expression | suffix}}</span></div>
              
            </grade-fascia>
              
          </grade-item>

          <!-- target -->	 
	        <grade-item icon=chevron-right>
	        
            <div layout vertical flex>
				
              <grade-fascia>
				        
		            <grade-dropdown-menu fascia-title flex
		                 disabled="{{ !editable }}" 
		                 selected="{{ item.model.bean[K.target] }}"
					           label="{{ K.target | suffix }} ?" 
					           required
					           invalid="{{ item.fieldsInvalidity[K.target] }}"
					           >
					        <template repeat="{{target in endpoints.synchedData}}">
					          <paper-item truncate label="{{target.model.name}}" dropitem="{{target.model.id}}"></paper-item>
	                </template>
		            </grade-dropdown-menu>
		            <div fascia-subtitle truncate><span>{{ K.target | start }}</span><span fg bolder>{{ K.target | suffix}}</span></div>
					        
		          </grade-fascia>

							<!-- graphs -->
							<grade-fascia truncate>
							   
							   <div graphs-area horizontal layout flex fascia-title>
							   
							     <div smaller vertical layout flex>
							       <div relative wired rounded flex>
							          <loading-panel fit loading="{{target.loadingGraphs==true}}" message="loading the graphs" style="overflow-y:auto;">
							             <div graphs>
								             <grade-selector id="targetGraphs"  
								                            notap="{{!editable}}" 
								                            selected="{{item.model.graphs}}" 
								                            multi 
								                            valueattr="item" 
								                            selectedAttribute="fg">
								              <template repeat="{{graph in target.model.graphs}}">
								                <div smaller pointer?={{editable}} item={{graph.uri}}>{{graph.label !=null?graph.label:suffix(graph.uri)}}</div>
								              </template>
								              <template repeat="{{graphUri in invalidGraphUris }}">
                                <div smaller pointer?={{editable}} item={{graphUri}} invalid-graph>{{suffixIfPresent(graphUri)}}</div>
                              </template>
								            </grade-selector>
                            </div>
							          </loading-panel>
							        </div>
							         <field-error show="{{!invalidGraphUris.isEmpty}}">Some graph are no longer a valid choice, pick another.</field-error>
							       </div>
							       
							       <grade-button disabled?={{!editable}} side icon=refresh label="refresh graphs" on-click={{refreshTargetGraphs}}></grade-button>
							
							   </div>
							            
							     
							  <grade-uri fascia-subtitle value="{{K.graph}}"></grade-uri>
							  
							</grade-fascia>   
          
            </div>
				    
	        </grade-item>
	        
          <!-- parameters -->
		      <grade-item icon=chevron-right>
		      
		        <grade-fascia truncate>
                  
              <div fascia-title>{{ parameters }}</div>
              <div fascia-subtitle><span>{{ K.parameters | start }}</span><span fg bolder>{{ K.parameters | suffix}}</span></div>
                  
            </grade-fascia>

        </grade-item>
		   
          <!-- endpoin -->
		      <grade-item icon=chevron-right>
		       
						<grade-fascia truncate>
						
							<div fascia-title>{{ item.model.endpoint }}</div>
							<div fascia-subtitle><span>{{ K.endpoint | start }}</span><span fg bolder>{{ K.endpoint | suffix}}</span></div>
						     
						</grade-fascia>
		           
		      </grade-item>
	          
	      </div>
	    </loading-panel>
    </div>
		
  </template> 
</polymer-element>
