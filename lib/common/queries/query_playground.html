<link rel="import" href="../../../../packages/polymer/polymer.html">

<link rel="import" href="../coming_soon.html">

<link rel="import" href="../components/grade_input.html">
<link rel="import" href="../components/grade_item.html">
<link rel="import" href="../components/grade_fascia.html">

<link rel="import" href="../components/grade_header_panel.html">
<link rel="import" href="../components/grade_button.html">
<link rel="import" href="../components/grade_error.html">
<link rel="import" href="../components/loading_panel.html">

<link rel="import" href="../../../../packages/core_elements/av_icons.html">
<link rel="import" href="../../../../packages/core_elements/core_pages.html">
<link rel="import" href="../../../../packages/core_elements/core_splitter.html">
<link rel="import" href="../../../../packages/core_elements/core_animated_pages.html">
<link rel="import" href="../../../../packages/core_elements/core_collapse.html">
<link rel="import" href="../../../../packages/paper_elements/paper_fab.html">
<link rel="import" href="../../../../packages/paper_elements/paper_tabs.html">
<link rel="import" href="../../../../packages/paper_elements/paper_tab.html">
<link rel="import" href="../../../../packages/paper_elements/paper_input.html">

<polymer-element name="query-playground" layout vertical>  

  <template>
  
    <style>
      .runButton {
				position: absolute;
				right: 16px;
				bottom: -46px;
				z-index: 1000;
      }
      
       /* spacing */
      
        :host paper-input, 
        :host paper-input::shadow .mirror-text
        
        {
          padding: 0px;
        }
        
        /* underline */
        
        :host paper-input::shadow .underline {
          border:none
        }
        
        :host paper-input::shadow .unfocused-underline {
        height: 0px;
          border:none
        }
        
         :host paper-input::shadow .focused-underline {
                height: 0px;
          border:none
        }
        
        :host paper-input[disabled]::shadow .underline {
          border:none
        }
   
    </style>
    
    <div style="height:60%;" wired rounded spaced layout vertical>
      <grade-header-panel flex paneltitle={{title}}>
        <grade-button menu icon="arrow-back" on-click="{{onBack}}"></grade-button>
        <div main fit layout vertical>
          <div flex wired rounded spaced layout horizontal style="min-height:75px;">
	          <paper-input multiline rows="6" maxrows="6" flex layout vertical style="margin: 5px;"
	          inputValue="{{editableQuery.model.bean[expression_key]}}"
	          disabled?="{{!editableQuery.edit}}"
	          required="true"
	          invalid="{{ editableQuery.fieldsInvalidity[expression_key] }}"
	          >
	          </paper-input>
          </div>
          
          <div horizontal layout wrap style="overflow-y: auto; min-height:50px;">
            <template repeat="{{key in editableQuery.model.parameters}}">
              <grade-item style="width:200px"> 
                <grade-fascia flex>    
                  <grade-input fascia-title 
                               label="{{key}}" 
                               required=true
                               invalid="{{ editableQuery.parametersInvalidity[key] }}"
                               inputValue="{{editableQuery.parametersValues[key]}}">
                  </grade-input>
                  <div fascia-subtitle><span fg bolder>{{key}}</span></div>
                </grade-fascia>
	            </grade-item>
	          </template>            
          </div>
        </div>
        
      </grade-header-panel>
      <div style="position: relative; width: 0; height: 0" self-end >
        <paper-fab class="runButton" mini="true" icon="av:play-arrow" on-click="{{onRun}}" hide?="{{!editableQuery.valid || !editableQuery.validParameters}}"></paper-fab>
      </div>
    </div>
  
    <core-splitter direction="up" allowOverflow minSize="170px"></core-splitter>
    
    <div flex wired rounded spaced layout vertical>
      <grade-header-panel flex paneltitle="Results">
         <paper-tabs toolbar  style="width:200px" selected="{{resultArea}}" hide?="{{editableQuery.lastQueryResult==null || editableQuery.queryRunning || editableQuery.lastError!=null}}" >
          <paper-tab>Table</paper-tab>
          <paper-tab>Raw</paper-tab>
        </paper-tabs>
        <loading-panel main fit loading="{{editableQuery.queryRunning}}" message="retrieving results">
          <core-animated-pages selected="{{resultArea}}" fit spaced hide?="{{editableQuery.lastQueryResult==null}}">
            <div style="overflow-y: auto;">
	            <table style="border-collapse: collapse; width:100%">
	              <tr>
	                <th template repeat="{{header in editableQuery.lastQueryResult.headers}}" result-table?="{{!editableQuery.dirty}}" result-table-disabled?="{{editableQuery.dirty}}">{{header}}</th>
	              </tr> 
	               
	              <tr template repeat="{{row in editableQuery.lastQueryResult.rows}}">
	                <td template repeat="{{header in editableQuery.lastQueryResult.headers}}" result-table?="{{!editableQuery.dirty}}" result-table-disabled?="{{editableQuery.dirty}}">
	                    {{row[header]["value"]}}
	                </td>
	              </tr>
	            </table>
            </div>
             
						<div style="overflow-y: auto;">
						  <pre>
						    {{editableQuery.lastQueryResult.raw}}
						  </pre>
						</div>
          
          </core-animated-pages>
          
         <div layout horizontal center-justified 
               hide?="{{editableQuery.lastQueryResult!=null || editableQuery.lastError!=null}}" style="overflow:hidden"> 
         </div>
         
         <template if="{{editableQuery.lastError!=null}}">

            <grade-error one="{{errorMessage()}}"
                 two = {{editableQuery.lastError.message}}
                 three = {{editableQuery.lastError.stacktrace}}>
            </grade-error>
                  
         </template>
            
            
        </loading-panel>
      </grade-header-panel>
    </div>
  </template>
  <script type="application/dart" src="queries.dart"></script> 
</polymer-element>